# Как проверить, ворк Amper или нет

## 1. Быстрая проверка (пинг API)

```bash
npm run amper-ping
```

- **WORK** в конце + код выхода 0 — API доступен, можно тестировать регистрацию.
- **NOT WORK** + код выхода 1 — смотри текст (нет токена, 502, 401 и т.д.).

## Проверка доступности домена

Если Amper API возвращает 400 VALIDATION_ERROR на `/domains/check`, бот автоматически делает проверку через **WHOIS**: занят домен или свободен. Результат показывается пользователю (доступен / недоступен), после чего можно перейти к регистрации.

## 2. Полный тест (check + register)

```bash
npm run test-amper-register example.com
```

Смотри вывод:
- Проверка доступности: 200 и JSON — ок; 400 VALIDATION_ERROR — известная особенность Amper; 502/503/504 — сервер лежит.
- Регистрация: 200 — ок; 400 с текстом про `nameservers` — уже исправлено (массив); 502 — сервер лежит.

## 3. Проверка в боте

1. Запусти бота (`npm run dev` или `npm start`).
2. Зайди в раздел доменов → регистрация домена.
3. Введи домен (например `test12345678.com`).
4. Если Amper лежит: увидишь сообщение про временную недоступность (502/503/504).
5. Если Amper ок: либо «доступен» и можно идти в регистрацию, либо ошибка формата/занят — по тексту будет понятно.

## Итог

| Команда | Что проверяет |
|--------|----------------|
| `npm run amper-ping` | Доступен ли Amper API вообще |
| `npm run test-amper-register <domain>` | Check + register до реальной оплаты |
| Бот → Домены → Регистрация | Полный сценарий как у пользователя |

Если `amper-ping` даёт WORK — интеграция с твоей стороны ок; если Amper возвращает 502 — проблема на их стороне, жди или пиши в поддержку Amper.

---

## 401 Unauthorized — «Invalid or expired API key»

Это значит, что **токен в `.env` не принимается** Amper. Код отправляет его правильно (`Authorization: ApiKey <token>`).

**Что сделать:**

1. Зайди в кабинет Amper (или туда, где выдавали API‑ключ) и проверь:
   - ключ активен и не отозван;
   - скопирован целиком, без пробелов в начале/конце.
2. В `.env` должно быть одно из:
   - `AMPER_API_TOKEN=sk_live_твой_ключ` (без кавычек, если в ключе нет пробелов);
   - или `AMPER_API_TOKEN=ApiKey sk_live_...` — тогда префикс `ApiKey ` уже в переменной.
3. Если ключ перевыпускали — вставь **новый** ключ в `.env` и перезапусти бота / скрипты.
4. Если всё верно, но 401 остаётся — напиши в поддержку Amper (@amper_domains_bot или support@amper.lat): «API возвращает 401 Invalid or expired API key для ключа sk_live_... (последние 4 символа: XXXX). Ключ активен в кабинете. Проверьте, пожалуйста.»  
   Само значение ключа в письме не отправляй, только тип и последние символы.
