# Автоматические рассылки и триггеры

Кто что отправляет пользователю **без ручного действия** (по событию или по расписанию).

---

## 1. После успешного пополнения баланса

| Что отправляется | Триггер | Условие |
|------------------|--------|--------|
| Сообщение «+ $X $» (и при наличии — строки про бонус upsell/реактивации) | Зачисление платежа (TopUp → Completed) | Всегда после успешного пополнения. |
| Отдельное сообщение: **«Пополните ещё $50 и получите +10% бонуса»** | То же (сразу после пополнения) | Пополнение **≥ 50 $** и пользователь **не получал growth-оффер за последние 24 часа**. Оффер создаётся на 30 минут; при следующем пополнении ≥50$ в течение этого времени начисляется бонус 10%. |

**Где в коде:** `src/api/payment.ts` → `paymentSuccess()` → вызов `GrowthService.handleTopUpSuccess()` и при `upsellOfferCreated` — `sendMessage(..., messageOffer)`.

---

## 2. Реактивация (неактивные 30 дней)

| Что отправляется | Триггер | Условие |
|------------------|--------|--------|
| **«Вернитесь и получите +15% к депозиту!»** | Cron **раз в 24 часа** | Пользователь: не заходил **30 дней** (`lastUpdateAt`), **баланс = 0**, **нет активных VDS и дедиков**. Сообщение уходит каждому такому пользователю (лимит 200 за запуск). Одновременно создаётся оффер на 48 ч: при первом пополнении начисляется бонус 15%. |

**Где в коде:** `src/app/bot.ts` → `startReactivationCron(dataSource, sendMessage)`; логика в `src/modules/growth/reactivation.service.ts` и `growth.module.ts`.

---

## 3. Напоминание об истечении VDS (3 дня на продление)

| Что отправляется | Триггер | Условие |
|------------------|--------|--------|
| Локализованное сообщение по ключу **vds-expiration** (например: «Ваша VDS истекает. Пополните баланс на {$amount} $») | ExpirationService проверяет раз в **сутки** просроченные VDS | По VDS: срок оплаты прошёл, у пользователя **недостаточно баланса** для продления. Выставляется дата удаления через 3 дня (`payDayAt`) и **один раз** отправляется это напоминание. |
| Отдельного сообщения «продлите и получите 5%» **нет** | В тот же момент вызывается Growth: создаётся **trigger-оффер** (скидка 5% при продлении, TTL 72 ч) | Скидка применяется автоматически при продлении, если оффер ещё активен. Сообщение в Telegram с текстом про 5% не отправляется. |

**Где в коде:** `src/domain/services/ExpirationService.ts` → `checkExpiredVds()` → `notifyUser(..., "vds-expiration", { amount })` и при наличии — `onGracePeriodStarted()` → `TriggerEngine.handleServiceExpiration()` (только создание оффера в хранилище).

---

## 4. Домены (истечение)

| Что отправляется | Триггер | Условие |
|------------------|--------|--------|
| Сейчас автоматических рассылок при истечении домена **нет** | ExpirationService обрабатывает просроченные домены (списание с баланса или пометка Expired) | Отдельное сообщение пользователю о «3 днях на продление» для доменов не реализовано. |

---

## 5. Рассылки по сегментам (не автоматические)

| Что отправляется | Триггер | Условие |
|------------------|--------|--------|
| Произвольный текст по сегменту | **Ручной** вызов `BroadcastService.sendToSegment(segment, message)` из кода/админки | Кто-то явно вызывает метод и передаёт сегмент и текст. Автоматического расписания нет. |

Доступные сегменты: `active_vps`, `domain_only`, `inactive_30d`, `high_spender`, `new_user`.

---

## Сводная таблица

| Рассылка | Триггер | Частота / момент |
|----------|--------|-------------------|
| «+ $X $» (+ бонусы при наличии) | Успешное пополнение | Каждое пополнение |
| «Пополните ещё $50 и получите +10% бонуса» | Успешное пополнение ≥50$ | Не чаще 1 раза в 24 ч на пользователя |
| «Вернитесь и получите +15% к депозиту!» | Cron | Раз в 24 ч, только подходящим по критериям неактивности |
| «Ваша VDS истекает. Пополните баланс на $X» | ExpirationService | Раз в сутки при переходе VDS в «3 дня до удаления» |
| Скидка 5% при продлении | Тот же момент (grace period) | Не рассылка — оффер создаётся, скидка применяется при продлении |
| По сегментам | Вручную | Только при вызове `sendToSegment` |

---

## 6. Новые кампании (cron 24h или по событию)

Глобальное ограничение: **не более 1 коммерческого пуша в 72 часа** на пользователя (любая из кампаний ниже).

| № | Кампания | Триггер | Сообщение | Ограничение |
|---|----------|--------|-----------|--------------|
| 1 | **Usage upsell** | Cron + метрики (CPU >70%, RAM >80%, диск >85%, I/O, 90% трафика). Пока **заглушка**: метрики из панели не подключены. | «Нагрузка на VDS близка к лимиту. Апгрейд до тарифа X — +40% ресурсов, без даунтайма. Скидка 10% на 48ч.» | 1 раз в 7 дней |
| 2 | **Win-back** | Cron 24h. Баланс ≥ $X (10$), нет активных услуг 7 дней. | «У вас $X на балансе. Запустите VDS сегодня — +5% к сроку.» | 72h global |
| 3 | **Behavioral upsell** | 3+ входа в панель за 24ч. **Заглушка**: нет источника «логинов». | «Вижу активную работу. Нужны snapshot/backup/доп IP? Подключите за 1 клик.» | 72h global |
| 4 | **Scarcity** | Cron. 1–2 дня до конца месяца. | «Закрываем месяц. +12% бонус к пополнению до 23:59.» | 1 раз в месяц |
| 5 | **Cross-sell** | Cron. Есть VDS, нет домена. | «Для стабильности проекта подключите резервный IP / бэкап-пакет. -7% 72 часа.» | 1 раз в 14 дней |
| 6 | **Anti-churn** | Был активный сервер 60+ дней, снижение трафика/логинов. **Заглушка**: нет метрик. | «Видим снижение активности. Предлагаем оптимизацию тарифа или перенос на более выгодный план.» | 72h global |
| 7 | **Tier (геймификация)** | После пополнения: переход в новый tier (Bronze → Silver → Gold → Platinum по cumulative deposit). | «Вы перешли в Silver. Теперь +3% к каждому пополнению.» и т.д. | Только при смене tier; 72h global |
| 8 | **Referral push** | После пополнения ≥ $20. | «Поделитесь реферальной ссылкой. За первый депозит реферала — +10% на ваш баланс.» | 1 раз в 30 дней; 72h global |
| 9 | **Smart retarget (VDS grace)** | ExpirationService ежедневно: VDS в grace (payDayAt). Day 2: ~48–24ч до удаления; Day 3: ~24–0ч. | Day 2: «+5% скидка при продлении действует ещё 24ч. Продлите сейчас.» Day 3: «Последний шанс продлить без потери данных. Скидка 5% ещё активна.» | По одному разу на VDS (day2, day3) |
| 10 | **Large deposit** | Пополнение ≥ $300. | «Спасибо за крупное пополнение. Хотите закрепить бонус +3% навсегда? Пополните ещё $200 в течение 24ч.» | 72h global |
| 11 | **NPS** | Cron. 14 дней с момента создания первого VDS у пользователя. | «Оцените сервис от 1 до 5.» (при 4–5 — отдельный ответ в диалоге). | 1 раз в год |
| 12 | **LTV-бонус** | Сегментация по давности регистрации: newbie 0–30d, active 30–180d, VIP 180+d. Разная бонусная логика; VIP — привилегии (приоритетный тикет). | Используется при начислении/отображении; отдельное сообщение только для VIP (привилегия). | — |
| 13 | **Incident upsell** | При падении/инциденте сервера (webhook). **Заглушка**: webhook не подключён. | «Рекомендуем подключить мониторинг + авто-ребут. Бесплатно 7 дней.» | 72h global |
| 14 | **Anniversary** | Cron. 1 год с даты регистрации. | «Год с нами. +15% к пополнению в течение 48ч.» | 1 раз в год |
| 15 | **B2B dedicated** | Cron. 2+ VDS, сумма пополнений > $1000. | «Рассмотрите выделенный сервер. Выгода до 18% по сравнению с текущими расходами.» | 1 раз в 14 дней |

**Где в коде:**  
- Cron всех кампаний: `src/app/bot.ts` → `runAllCampaignsCron(dataSource, sendMessage)` раз в 24ч.  
- По событию пополнения: `src/api/payment.ts` (tier, large deposit, referral push — не более одного из них за 72h).  
- Grace Day 2/3: `src/domain/services/ExpirationService.ts` → `onGraceDayCheck` → `maybeSendGraceDay2OrDay3` из `src/modules/growth/campaigns/grace-retarget.campaign.ts`.  
- Кампании: `src/modules/growth/campaigns/*.ts`.

---

## Ограничение «не спамить»

- Не больше **одного growth-оффера в 24 часа** на пользователя (upsell-предложение «+50$ и +10%» не придёт чаще).
- **Не более 1 коммерческого пуша в 72 часа** на пользователя (все новые кампании + при необходимости реактивация/другие рассылки должны учитывать этот лимит).
- Реактивация: один и тот же пользователь может попадать в выборку каждый день, пока не пополнит или не зайдёт (сообщение «Вернитесь и получите +15%» может повторяться раз в сутки, пока он в списке неактивных).
